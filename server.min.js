/** Web server functions. @preserve Copyright (c) 2021 Manuel LÃµhmus. */
function log(n){var i=new Date,r=path.resolve(__dirname,options.logDir,i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate()+".log"),t=n.req.client.remoteAddress+" ";t+="["+i.toLocaleString()+"] ";t+='"'+n.req.headers.host+" "+n.req.method+" "+n.req.url+" HTTP/"+n.req.httpVersion+'" ';t+=n.statusCode+" ";t+=n.req.client.remotePort+" ";t+='"'+n.req.headers["user-agent"]+'"\r\n';fs.appendFile(r,t,{flag:"a+"},function(n){n&&console.error(n)})}function static_reqest(n,t){var i=n.url,r,u;(!i.length||i.endsWith("/"))&&(i+=options.directory_index);i.startsWith("/")&&(i=i.substr(1));r=n.headers.host.replace(":"+options.port,"");r=r.replace(options.domain,"");r.endsWith(".")&&(r=r.substr(0,r.length-1));u=r===""?options.document_root:options.subdomains[r];u&&n.method.toLocaleUpperCase()==="GET"?(i=path.resolve(process.cwd(),u,i),static_file(i,t,function(){i=path.resolve(process.cwd(),options.document_root,options.pathToError_404);static_file(i,t,function(i){i||not_found_content(n,t)})})):not_found_content(n,t)}function static_file(n,t,i){fs.exists(n,function(r){if(r){var f=n.endsWith(path.parse(options.pathToError_404).base)?404:200,u=mimeTypes[path.extname(n)];u||(u="");t.writeHead(f,{"Content-Type":u});fs.createReadStream(n).pipe(t)}else i()})}function not_found_content(n,t){console.info("Warning: 404 Not Found",{url:n.url,ip:n.socket.remoteAddress,userAgent:n.headers["user-agent"]});t.writeHead(404,{"Content-Type":"text/plain"});t.write("404 Not Found Url: "+n.url+"\n");options.isDebug&&t.write("Headers: "+JSON.stringify(n.headers,null,2)+"\n");t.end()}var server,emit;"use strict";var options=require("config-sets").init({tiny_https_server:{domain:"localhost",port:"",logDir:"./log/tiny-https-server",document_root:"./public/www",directory_index:"index.html",pathToError_404:"./error_404.html",pathToPrivkey:"",pathToCert:"",subdomains:{}}}).tiny_https_server,http=require("http"),https=require("https"),isSSL=options.pathToPrivkey!==""&&options.pathToCert!=="",port=options.port||(isSSL?443:80),path=require("path"),fs=require("fs"),mimeTypes=require(path.resolve(__dirname,"mimeTypes.js")),logDir=path.resolve(process.cwd(),options.logDir);fs.existsSync(logDir)||fs.mkdirSync(logDir,{recursive:!0});isSSL&&port===443&&http.createServer(function(n,t){n.url.startsWith("/.")?static_reqest(n,t):(t.writeHead(302,{Location:"https://"+n.headers.host+n.url}),t.end())}).listen(80);server=isSSL&&port!==80?https.createServer({key:fs.readFileSync(options.pathToPrivkey),cert:fs.readFileSync(options.pathToCert)}):http.createServer();emit=server.emit;server.emit=function(){var t=arguments,n;if(t[0]==="request"){t[2].on("finish",function(){log(this)});n=[];server._events.request&&(typeof server._events.request=="function"?n.push(server._events.request):n=n.concat(server._events.request));n.push(static_reqest);function i(){if(n.length){var r=n.shift();r(t[1],t[2],i)}}i()}else emit.apply(server,t)};server.listen(port,function(n){n?console.error(n):console.log("Webserver port:"+port+" pid:"+process.pid)});module.exports=server;